import{Controller as t}from"stimulus";import e from"lodash.debounce";class s extends t{connect(){this.resultsTarget.hidden=!0,this.inputTarget.setAttribute("autocomplete","off"),this.inputTarget.setAttribute("spellcheck","false"),this.mouseDown=!1,this.onInputChange=e(this.onInputChange.bind(this),300),this.onResultsClick=this.onResultsClick.bind(this),this.onResultsMouseDown=this.onResultsMouseDown.bind(this),this.onInputBlur=this.onInputBlur.bind(this),this.onKeydown=this.onKeydown.bind(this),this.inputTarget.addEventListener("keydown",this.onKeydown),this.inputTarget.addEventListener("blur",this.onInputBlur),this.inputTarget.addEventListener("input",this.onInputChange),this.resultsTarget.addEventListener("mousedown",this.onResultsMouseDown),this.resultsTarget.addEventListener("click",this.onResultsClick)}disconnect(){this.hasInputTarget&&(this.inputTarget.removeEventListener("keydown",this.onKeydown),this.inputTarget.removeEventListener("focus",this.onInputFocus),this.inputTarget.removeEventListener("blur",this.onInputBlur),this.inputTarget.removeEventListener("input",this.onInputChange)),this.hasResultsTarget&&(this.resultsTarget.removeEventListener("mousedown",this.onResultsMouseDown),this.resultsTarget.removeEventListener("click",this.onResultsClick))}sibling(t){const e=Array.from(this.resultsTarget.querySelectorAll('[role="option"]')),s=this.resultsTarget.querySelector('[aria-selected="true"]'),i=e.indexOf(s);return(t?e[i+1]:e[i-1])||(t?e[0]:e[e.length-1])}select(t){for(const t of this.resultsTarget.querySelectorAll('[aria-selected="true"]'))t.removeAttribute("aria-selected"),t.classList.remove("active");t.setAttribute("aria-selected","true"),t.classList.add("active"),this.inputTarget.setAttribute("aria-activedescendant",t.id)}onKeydown(t){switch(t.key){case"Escape":this.resultsTarget.hidden||(this.hideAndRemoveOptions(),t.stopPropagation(),t.preventDefault());break;case"ArrowDown":{const e=this.sibling(!0);e&&this.select(e),t.preventDefault()}break;case"ArrowUp":{const e=this.sibling(!1);e&&this.select(e),t.preventDefault()}break;case"Tab":{const t=this.resultsTarget.querySelector('[aria-selected="true"]');t&&this.commit(t)}break;case"Enter":{const e=this.resultsTarget.querySelector('[aria-selected="true"]');e&&!this.resultsTarget.hidden&&(this.commit(e),t.preventDefault())}}}onInputBlur(){this.mouseDown||(this.resultsTarget.hidden=!0)}commit(t){if("true"===t.getAttribute("aria-disabled"))return;if(t instanceof HTMLAnchorElement)return t.click(),void(this.resultsTarget.hidden=!0);const e=t.textContent.trim(),s=t.getAttribute("data-autocomplete-value")||e;this.inputTarget.value=e,this.hasHiddenTarget?this.hiddenTarget.value=s:this.inputTarget.value=s,this.inputTarget.focus(),this.hideAndRemoveOptions(),this.element.dispatchEvent(new CustomEvent("autocomplete.change",{bubbles:!0,detail:{value:s,textValue:e}}))}onResultsClick(t){if(!(t.target instanceof Element))return;const e=t.target.closest('[role="option"]');e&&this.commit(e)}onResultsMouseDown(){this.mouseDown=!0,this.resultsTarget.addEventListener("mouseup",()=>this.mouseDown=!1,{once:!0})}onInputChange(){this.element.removeAttribute("value"),this.fetchResults()}identifyOptions(){let t=0;for(const e of this.resultsTarget.querySelectorAll('[role="option"]:not([id])'))e.id=`${this.resultsTarget.id}-option-${t++}`}hideAndRemoveOptions(){this.resultsTarget.hidden=!0,this.resultsTarget.innerHTML=null}fetchResults(){const t=this.inputTarget.value.trim();if(!t||t.length<this.minLength)return void this.hideAndRemoveOptions();if(!this.src)return;const e=new URL(this.src,window.location.href),s=new URLSearchParams(e.search.slice(1));s.append("q",t),e.search=s.toString(),this.element.dispatchEvent(new CustomEvent("loadstart")),fetch(e.toString()).then(t=>t.text()).then(t=>{this.resultsTarget.innerHTML=t,this.identifyOptions();const e=!!this.resultsTarget.querySelector('[role="option"]');this.resultsTarget.hidden=!e,this.element.dispatchEvent(new CustomEvent("load")),this.element.dispatchEvent(new CustomEvent("loadend"))}).catch(()=>{this.element.dispatchEvent(new CustomEvent("error")),this.element.dispatchEvent(new CustomEvent("loadend"))})}open(){this.resultsTarget.hidden&&(this.resultsTarget.hidden=!1,this.element.setAttribute("aria-expanded","true"),this.element.dispatchEvent(new CustomEvent("toggle",{detail:{input:this.input,results:this.results}})))}close(){this.resultsTarget.hidden||(this.resultsTarget.hidden=!0,this.inputTarget.removeAttribute("aria-activedescendant"),this.element.setAttribute("aria-expanded","false"),this.element.dispatchEvent(new CustomEvent("toggle",{detail:{input:this.input,results:this.results}})))}get src(){return this.data.get("url")}get minLength(){const t=this.data.get("min-length");return t?parseInt(t,10):0}}s.targets=["input","hidden","results"];export{s as Autocomplete};
//# sourceMappingURL=stimulus-autocomplete.modern.js.map
