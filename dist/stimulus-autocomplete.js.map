{"version":3,"file":"stimulus-autocomplete.js","sources":["../src/autocomplete.mjs"],"sourcesContent":["import { Controller } from 'stimulus'\nimport debounce from 'lodash.debounce'\n\nexport default class extends Controller {\n  static targets = [ 'input', 'hidden', 'results' ]\n\n  connect() {\n    this.resultsTarget.hidden = true\n\n    this.inputTarget.setAttribute('autocomplete', 'off')\n    this.inputTarget.setAttribute('spellcheck', 'false')\n\n    this.mouseDown = false\n\n    this.onInputChange = debounce(this.onInputChange.bind(this), 300)\n    this.onResultsClick = this.onResultsClick.bind(this)\n    this.onResultsMouseDown = this.onResultsMouseDown.bind(this)\n    this.onInputBlur = this.onInputBlur.bind(this)\n    this.onKeydown = this.onKeydown.bind(this)\n\n    this.inputTarget.addEventListener('keydown', this.onKeydown)\n    this.inputTarget.addEventListener('blur', this.onInputBlur)\n    this.inputTarget.addEventListener('input', this.onInputChange)\n    this.resultsTarget.addEventListener('mousedown', this.onResultsMouseDown)\n    this.resultsTarget.addEventListener('click', this.onResultsClick)\n  }\n\n  disconnect() {\n    if (this.hasInputTarget) {\n      this.inputTarget.removeEventListener('keydown', this.onKeydown)\n      this.inputTarget.removeEventListener('focus', this.onInputFocus)\n      this.inputTarget.removeEventListener('blur', this.onInputBlur)\n      this.inputTarget.removeEventListener('input', this.onInputChange)\n    }\n    if (this.hasResultsTarget) {\n      this.resultsTarget.removeEventListener(\n        'mousedown',\n        this.onResultsMouseDown\n      )\n      this.resultsTarget.removeEventListener('click', this.onResultsClick)\n    }\n  }\n\n  sibling(next) {\n    const options = Array.from(this.resultsTarget.querySelectorAll('[role=\"option\"]'))\n    const selected = this.resultsTarget.querySelector('[aria-selected=\"true\"]')\n    const index = options.indexOf(selected)\n    const sibling = next ? options[index + 1] : options[index - 1]\n    const def = next ? options[0] : options[options.length - 1]\n    return sibling || def\n  }\n\n  select(target) {\n    for (const el of this.resultsTarget.querySelectorAll('[aria-selected=\"true\"]')) {\n      el.removeAttribute('aria-selected')\n      el.classList.remove('active')\n    }\n    target.setAttribute('aria-selected', 'true')\n    target.classList.add('active')\n    this.inputTarget.setAttribute('aria-activedescendant', target.id)\n  }\n\n  onKeydown(event) {\n    switch (event.key) {\n      case 'Escape':\n        if (!this.resultsTarget.hidden) {\n          this.hideAndRemoveOptions()\n          event.stopPropagation()\n          event.preventDefault()\n        }\n        break\n      case 'ArrowDown':\n        {\n          const item = this.sibling(true)\n          if (item) this.select(item)\n          event.preventDefault()\n        }\n        break\n      case 'ArrowUp':\n        {\n          const item = this.sibling(false)\n          if (item) this.select(item)\n          event.preventDefault()\n        }\n        break\n      case 'Tab':\n        {\n          const selected = this.resultsTarget.querySelector('[aria-selected=\"true\"]')\n          if (selected) {\n            this.commit(selected)\n          }\n        }\n        break\n      case 'Enter':\n        {\n          const selected = this.resultsTarget.querySelector('[aria-selected=\"true\"]')\n          if (selected && !this.resultsTarget.hidden) {\n            this.commit(selected)\n            event.preventDefault()\n          }\n        }\n        break\n    }\n  }\n\n  onInputBlur() {\n    if (this.mouseDown) return\n    this.resultsTarget.hidden = true\n  }\n\n  commit(selected) {\n    if (selected.getAttribute('aria-disabled') === 'true') return\n\n    if (selected instanceof HTMLAnchorElement) {\n      selected.click()\n      this.resultsTarget.hidden = true\n      return\n    }\n\n    const textValue = selected.textContent.trim()\n    const value = selected.getAttribute('data-autocomplete-value') || textValue\n    this.inputTarget.value = textValue\n\n    if ( this.hasHiddenTarget ) {\n      this.hiddenTarget.value = value\n    } else {\n      this.inputTarget.value = value\n    }\n\n    this.inputTarget.focus()\n    this.hideAndRemoveOptions()\n\n    this.element.dispatchEvent(new CustomEvent('autocomplete.change', {\n      bubbles: true,\n      detail: { value: value, textValue: textValue }\n    }))\n  }\n\n  onResultsClick(event) {\n    if (!(event.target instanceof Element)) return\n    const selected = event.target.closest('[role=\"option\"]')\n    if (selected) this.commit(selected)\n  }\n\n  onResultsMouseDown() {\n    this.mouseDown = true\n    this.resultsTarget.addEventListener('mouseup', () => (this.mouseDown = false), {once: true})\n  }\n\n  onInputChange() {\n    this.element.removeAttribute('value')\n    this.fetchResults()\n  }\n\n  identifyOptions() {\n    let id = 0\n    for (const el of this.resultsTarget.querySelectorAll('[role=\"option\"]:not([id])')) {\n      el.id = `${this.resultsTarget.id}-option-${id++}`\n    }\n  }\n\n  hideAndRemoveOptions() {\n    this.resultsTarget.hidden = true\n    this.resultsTarget.innerHTML = null\n  }\n\n  fetchResults() {\n    const query = this.inputTarget.value.trim()\n    if (!query || query.length < this.minLength) {\n      this.hideAndRemoveOptions()\n      return\n    }\n\n    if (!this.src) return\n\n    const url = new URL(this.src, window.location.href)\n    const params = new URLSearchParams(url.search.slice(1))\n    params.append('q', query)\n    url.search = params.toString()\n\n    this.element.dispatchEvent(new CustomEvent('loadstart'))\n\n    fetch(url.toString())\n      .then(response => response.text())\n      .then(html => {\n        this.resultsTarget.innerHTML = html\n        this.identifyOptions()\n        const hasResults = !!this.resultsTarget.querySelector('[role=\"option\"]')\n        this.resultsTarget.hidden = !hasResults\n        this.element.dispatchEvent(new CustomEvent('load'))\n        this.element.dispatchEvent(new CustomEvent('loadend'))\n      })\n      .catch(() => {\n        this.element.dispatchEvent(new CustomEvent('error'))\n        this.element.dispatchEvent(new CustomEvent('loadend'))\n      })\n  }\n\n  open() {\n    if (!this.resultsTarget.hidden) return\n    this.resultsTarget.hidden = false\n    this.element.setAttribute('aria-expanded', 'true')\n    this.element.dispatchEvent(new CustomEvent('toggle', {detail: {input: this.input, results: this.results}}))\n  }\n\n  close() {\n    if (this.resultsTarget.hidden) return\n    this.resultsTarget.hidden = true\n    this.inputTarget.removeAttribute('aria-activedescendant')\n    this.element.setAttribute('aria-expanded', 'false')\n    this.element.dispatchEvent(new CustomEvent('toggle', {detail: {input: this.input, results: this.results}}))\n  }\n\n  get src() {\n    return this.data.get(\"url\")\n  }\n\n  get minLength() {\n    const minLength = this.data.get(\"min-length\")\n    if ( !minLength ) {\n      return 0\n    }\n    return parseInt(minLength, 10)\n  }\n}\n"],"names":["connect","this","resultsTarget","hidden","inputTarget","setAttribute","mouseDown","onInputChange","debounce","bind","onResultsClick","onResultsMouseDown","onInputBlur","onKeydown","addEventListener","disconnect","hasInputTarget","removeEventListener","onInputFocus","hasResultsTarget","sibling","next","options","Array","from","querySelectorAll","selected","querySelector","index","indexOf","length","select","target","el","removeAttribute","classList","remove","add","id","event","key","hideAndRemoveOptions","stopPropagation","preventDefault","item","commit","getAttribute","HTMLAnchorElement","click","textValue","textContent","trim","value","hasHiddenTarget","hiddenTarget","focus","element","dispatchEvent","CustomEvent","bubbles","detail","Element","closest","_this","once","fetchResults","identifyOptions","innerHTML","query","minLength","src","url","URL","window","location","href","params","URLSearchParams","search","slice","append","toString","fetch","then","response","text","html","_this2","hasResults","open","input","results","close","data","get","parseInt","Controller","targets"],"mappings":"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"}